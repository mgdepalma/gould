#!/bin/sh
##
# xsession - X Window session startup script for GOULD.
#
# 2023-09-09 Generations Linux <bugs@softcraft.org>
echo $PATH | grep -q /usr/bin/X11 || PATH="/usr/bin/X11:$PATH"

# source desktop resource configurations (system and user)
[ -r /etc/sysconfig/desktop ] && . /etc/sysconfig/desktop
[ -r $HOME/.config/desktop ] && . $HOME/.config/desktop

# consult CGonf repository for background properties
[ -n "$BACKGROUND" -a -r $BACKGROUND ] && {\
 gconftool -t string -s /desktop/gnome/background/picture_filename $BACKGROUND
 [ `type -p xsetbg` ] && xsetbg $BACKGROUND
}

# export {WINDOWMANAGER}, {SCREENSAVER}. {LAUNCHER}, {DESKTOP}
export WINDOWMANAGER=${WINDOWMANAGER:-"openbox"}

[ -n "$SCREENSAVER" ] && export SCREENSAVER=$SCREENSAVER
[ -n "$LAUNCHER" ] && export LAUNCHER=$LAUNCHER

[ -n "$DESKTOP" ] && {
  export DESKTOP=$DESKTOP
  RUNNING=$(pidof $DESKTOP)
  [ -n "$RUNNING" ] && kill -KILL $DESKTOP
}

SESSION=gsession
if [ `type -p gsession` ]; then
  #(any)gsession force exit
  RUNNING=$(pidof gsession)
  [ -n "$RUNNING" ] && kill -KILL $RUNNING
else
  # fallback to starting {WINDOWMANAGER} if gsession is not available
  SESSION=$WINDOWMANAGER
fi

# Since gvfs exports dbus services, gvfsd should be actually started by dbus.
exec dbus-launch --exit-with-session --sh-syntax ${SESSION}

#/
